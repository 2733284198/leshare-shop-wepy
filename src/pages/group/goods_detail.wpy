<template>
  <Loading :init.sync="init"/>

  <!--轮播展示图-->
  <view class="container column" wx:if="{{init}}">
    <swiper class="goods-swiper" indicator-dots="true" autoplay="true" interval="5000" @tap="previewDetailSwiper">
      <block wx:for="{{rules.goods.images}}" wx:key="id">
        <swiper-item>
          <image src="{{item.url}}/preview" mode="aspectFill" style="width: 100%"></image>
        </swiper-item>
      </block>
    </swiper>

    <!--拼团倒计时栏-->
    <TimeOutBar :endTime.sync="endTime" :callback="callback" />

    <!--商品基本信息展示-->
    <view class="row-between goods-msg-box">
      <view class="column">
        <view class="row mb20">
          <text class="xl">￥</text><text class="price-box">{{rules.price}}</text>
          <view class="column ml20">
            <text class="muted sellPrice-box sm">￥{{rules.goods.maxPrice}}</text>
            <view class="price-rule-box">
              <text class="xxs">{{rules.limitCustomer}}人拼团</text>
              <text class="ml10 xxs">{{save}}</text>
            </view>
          </view>
        </view>
        <text class="goods-name-box">{{rules.goods.name}}</text>
      </view>
      <view class="column-center">
        <icon class="share small" color="gray"/>
        <text class="muted sm">分享有惊喜</text>
      </view>
    </view>
    <view class="row-between goods-des-box">
      <view class="row">
        <icon class="status-6 xsmall"/>
        <text class="xs ml10">全场包邮</text>
      </view>
      <view class="row">
        <icon class="status-6 xsmall"/>
        <text class="xs ml10">七天退换</text>
      </view>
      <view class="row">
        <icon class="status-6 xsmall"/>
        <text class="xs ml10">假一赔十</text>
      </view>
      <icon class="more xsmall" color="gray"/>
    </view>
    <!--评论预览-->
    <CommentPreview :goodsId.sync="goodsId"/>

    <!--拼团栏-->
    <GroupInfoBar :processing.sync="processing" :info.sync="info"/>

    <!--滑出购物面板-->
    <block >
      <SilderPanel />
    </block>

    <!--底栏-->
    <GroupBar :rule.sync="rules" />
  </view>
</template>
<script>
  import wepy from 'wepy';
  import auth from '../../api/auth';
  import store from '../../store/utils';
  import base from '../../mixins/base';
  import Loading from '../../components/common/loading';
  import GroupBar from '../../components/group/bottom_group_bar';
  import TimeOutBar from '../../components/group/timeout_bar';
  import CommentPreview from '../../components/goods/comment_preview';
  import GroupInfoBar from '../../components/group/group_info_bar';
  import SilderPanel from '../../components/goods/slider_buy_panel';
  import group from '../../api/group';
  import Event from '../../utils/Event';

  export default class GroupGoodsDetail extends wepy.page {
    data = {
      init: false,
      buyPanelType: 'POPUP',
      endTime: '',
      goodsId: '',
      groupTime: '',
      ruleId: 25,
      rules: {},
      processing: {}
    };
    async onLoad () {
      this.upProcessingList();
      Event.listen(Event.GROUP_LIST_UPDATE, this.upProcessingList.bind(this), this)
    };
    async upProcessingList () {
      await auth.login();
      await store.init();
      this.rules = await group.rules(this.ruleId);
      this.processing = await group.processing(this.ruleId);
      this.endTime = this.rules.endTime;
      this.goodsId = this.rules.goodsId;
      this.groupTime = this.processing.map(item => {
        return item.groupTime
      });
      this.loaded();
    }
    /**
     * 页面分享
     */
    onShareAppMessage () {
      return {};
    }
    methods = {
      /**
       * 预览轮播图
       */
      previewDetailSwiper() {
        const urls = this.rules.goods.images.map(value => value.url);
        wepy.previewImage({
          urls: urls
        });
      }
    };
    computed = {
      save () {
        if (this.rules.price && this.rules.goods.maxPrice) {
          const num = (this.rules.goods.maxPrice * 1 - this.rules.price * 1).toFixed(2);
          return `拼团立省￥${num}`
        }
      }
    };
    components = {
      GroupBar: GroupBar,
      TimeOutBar: TimeOutBar,
      CommentPreview: CommentPreview,
      GroupInfoBar: GroupInfoBar,
      SilderPanel: SilderPanel,
      Loading: Loading
    };
    mixins = [base];
    config = {
      navigationBarTitleText: '商品详情'
    };
  }
</script>

<style lang="scss">
  @import "../../styles/variable";
  .goods-swiper{
    width: 750rpx;
    height:480rpx;
  }

  .goods-msg-box{
    background: white;
    padding: 20rpx;
    .price-box{
      font-size: 80rpx;
      line-height: 80rpx;
    }
    .sellPrice-box{
      text-decoration: line-through;
      line-height: $text-sm;
    }
    .price-rule-box{
      text{
        background: #FEE7EF;
        color: #FB4578;
        padding: 0 4rpx;
      }
    }
    .goods-name-box{
      font-size: 30rpx;
      line-height: 30rpx;
    }
  }
  .goods-des-box{
    background: white;
    padding: 20rpx;
    border-top:$border;
    margin-bottom: 10rpx;
    icon{
      color: $color-primary;
    }
  }
</style>
